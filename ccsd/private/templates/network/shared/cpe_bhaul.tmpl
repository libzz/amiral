#*doc-module:
crcnetd - CRCnet Configuration System Daemon Template

This template generates the firewall class for CPE devices backhaul
*#
#attr $author = "Matt Brown <matt@crc.net.nz>"
#attr $version = "$Id$"
#attr $copyright = "Copyright (C) 2006  The University of Waikato"
#attr $license = "No usage or redistribution rights are granted. See LICENSE for details."
#attr $eventList = []
#from crcnetd._utils.ccsd_cfengine import ccs_template
#extends ccs_template
#compiler-settings
## Change the Cheetah start tokens so that we don't conflict with CFengine
cheetahVarStartToken = %
directiveStartToken = !
commentStartToken = !!
EOLSlurpToken = ^^^
#end compiler-settings
!set %masq_restriction = ""
!! Find the CPE internal network and add a masquerade restriction
!for %link_id,%link in %links.items()
    !if %link["description"].find("CPE Internal") != -1
        !set %masq_restriction = "--source " + %link.network_address
    !end if
!end for
#############################################################
#
# cpe_bhaul -- for %domain 
# $Date$
#
# This file contains the firewall configuration for a CPE's
# backhaul interfaces
# 
# WARNING: Do not modify this file since it is automatically
#          generated by cf.py
#
#############################################################

# Always run these rules
on_startup

# People we allow to talk to us
policy in ACCEPT --protocol 41 # allow IPv6 on IPv4
policy in ACCEPT --protocol tcp --destination-port ssh 
policy in ACCEPT --protocol tcp --destination-port www
# Allow the policy server in for anything
policy in ACCEPT --source %policy_ip
policy in tcp-strict
policy in udp-strict
policy in icmp-trust
policy in multicast-trust

# Masquerade any traffic leaving onto the IP of this interface
policy postrouting-out MASQUERADE %masq_restriction
# If you want to restrict external access further you can add an extra
# option such as '--source 10.1.1.0/24' (no quotes) to the above command

# Advanced Configuration Examples

# Portforward external port 1234 to 1.2.3.4:5678
#policy prerouting-in DNAT --protocol tcp --dport 1234 --to 1.2.3.4:5678

# Having issues with stupid people breaking path MTU?
# policy out TCPMSS --protocol tcp --set-mss 576 --tcp-flags SYN,RST SYN \
# 	--destination 1.2.3.4

# Allow any traffic generated on this machine out to the Internet
policy out ACCEPT 

# Keep the internet clean - block known MS worm traffic
policy forward-in reject-ms
policy forward-out reject-ms

# Act as a good little router for all other traffic
policy forward-in ACCEPT
policy forward-out ACCEPT

if_feature rp_filter 1 		 # Enable Reverse Router Filtering
if_feature accept_redirects 0 	 # Accept Redirects
if_feature accept_source_route 0 # Accept Source Routes
if_feature bootp_relay 0         # Dont forward bootp requests
if_feature forwarding 1          # forward packets arriving on this interface
if_feature log_martians 0        # log martians?
if_feature send_redirects 1      # Send redirects?

